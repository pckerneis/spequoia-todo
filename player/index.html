<div id="viewer">
    <img id="screenshot" src=""/>
    <div id="transport-controls">
        <div id="timeline">
            <div id="timeline-bar" class="timeline-bar"></div>
            <div id="timeline-preview" class="timeline-preview" style="display:none;"></div>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button id="prev-section">⏮️</button>
            <button id="play-pause">▶️</button>
            <button id="next-section">⏭️</button>
            <p id="description"></p>
        </div>
    </div>
</div>

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
    }

    * {
        box-sizing: border-box;
    }

    #viewer {
        max-width: min(100%, 600px);
        display: flex;
        flex-direction: column;
        font-family: sans-serif;
    }

    .section {
        background: #eee;
        height: 100%;
        transition: transform 0.1s ease-in-out;
        transform: scaleY(80%);
        position: absolute;
        overflow: hidden;
    }

    .section:hover {
        transform: scaleY(120%);
    }

    .section-progress {
        background: #007bff;
        height: 100%;
        width: 0;
        position: absolute;
        left: 0;
        top: 0;
        pointer-events: none;
    }

    #timeline {
        position: relative;
    }

    .timeline-bar {
        height: 8px;
        border-radius: 2px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
    }

    .timeline-indicator {
        position: absolute;
        top: 0;
        left: 0;
        width: 16px;
        height: 16px;
        background: #007bff;
        border-radius: 50%;
        transform: translate(-50%, calc(4px - 50%));
        pointer-events: none;
    }

    .timeline-preview {
        position: absolute;
        pointer-events: none;
        z-index: 100;
        background: #222;
        color: #fff;
        border-radius: 6px;
        padding: 8px 12px 8px 8px;
        min-width: 80px;
        min-height: 60px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        font-size: 13px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        transition: opacity 0.1s;
    }

    .timeline-preview img {
        max-width: 90px;
        max-height: 60px;
        display: block;
        margin-bottom: 2px;
        border-radius: 3px;
        background: #111;
    }

    .timeline-preview .preview-section {
        font-weight: bold;
        font-size: 12px;
        color: #fff;
        margin-top: 2px;
        text-align: center;
        max-width: 100px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<script>
  let sections = [];
  let currentStep = 0;
  let playing = false;
  let playInterval = null;
  let allFrames = [];
  let currentFrame = 0;
  let frameStepMap = [];
  let frameDuration = 100;

  fetch('data/screenshot-manifest.json')
      .then(res => res.json())
      .then(data => {
        sections = data.sections;

        allFrames = [];
        for (let i = 0; i < data.frameCount; i++) allFrames.push(i);

        // Map each frame to the closest previous step index
        frameStepMap = allFrames.map(f => {
          for (let i = sections.length - 1; i >= 0; i--) {
            if (f >= sections[i].startFrame) return sections[i];
          }

          return null;
        });

        showFrame(0);
        renderTimeline();
      });

  function renderTimeline() {
    const timelineBar = document.getElementById('timeline-bar');

    // Remove old section bars, progress, and indicator
    timelineBar.innerHTML = '';

    if (!sections.length) return;

    for (let i = 0; i < sections.length; i++) {
      const section = sections[i];

      const sectionElement = document.createElement('div');
      sectionElement.className = 'section';
      sectionElement.title = section.name;
      sectionElement.style.position = 'absolute';

      const sectionLength = Math.min(section.endFrame, allFrames.length - 1) - section.startFrame;
      const sectionRelativeWidth = (sectionLength / (allFrames.length - 1)) * 100;
      sectionElement.style.width = section.endFrame < allFrames.length ? `calc(${sectionRelativeWidth}% - 2px)` : `${sectionRelativeWidth}%`;

      const sectionRelativePosition = (section.startFrame / (allFrames.length - 1)) * 100;
      sectionElement.style.left = sectionRelativePosition + '%';

      // Add progress bar inside section
      const progress = document.createElement('div');
      progress.className = 'section-progress';
      progress.dataset.sectionIndex = i;
      sectionElement.appendChild(progress);

      timelineBar.appendChild(sectionElement);
    }

    // Add moving indicator
    const indicator = document.createElement('div');
    indicator.id = 'timeline-indicator';
    indicator.className = 'timeline-indicator';
    timelineBar.appendChild(indicator);

    updateTimeline();
  }

  function showStep(i) {
    if (i < 0 || i >= sections.length) return;

    currentStep = i;

    const frameIdx = sections[currentStep].startFrame;

    showFrame(frameIdx >= 0 ? frameIdx : 0);
  }

  function showFrame(frameIdx) {
    if (frameIdx < 0 || frameIdx >= allFrames.length) return;
    currentFrame = frameIdx;
    const section = frameStepMap[frameIdx];
    document.getElementById('screenshot').src = `data/${allFrames[frameIdx]}.png`;
    document.getElementById('description').textContent = section.name;
    updateTimeline();
  }

  function next() {
    showStep(currentStep + 1);
  }

  function prev() {
    showStep(currentStep - 1);
  }

  function play() {
    if (playing) return;
    playing = true;
    document.getElementById('play-pause').textContent = '⏸️';
    playInterval = setInterval(() => {
      if (currentFrame < allFrames.length - 1) {
        showFrame(currentFrame + 1);
      } else {
        pause();
      }
    }, frameDuration);
  }

  function pause() {
    playing = false;
    document.getElementById('play-pause').textContent = '▶️';
    if (playInterval) clearInterval(playInterval);
  }

  function gotoSection(dir) {
    let target = currentStep + dir;
    if (target < 0) target = 0;
    if (target >= sections.length) target = sections.length - 1;
    showStep(target);
  }

  function updateTimeline() {
    const indicator = document.getElementById('timeline-indicator');

    if (indicator && allFrames.length > 1) {
      const percent = currentFrame / (allFrames.length - 1);
      indicator.style.left = (percent * 100) + '%';
    }

    for (let i = 0; i < sections.length; i++) {
      const section = sections[i];
      const progress = document.querySelector(`.section-progress[data-section-index="${i}"]`);

      if (!progress) continue;

      if (currentFrame >= section.endFrame) {
        progress.style.width = '100%';
      } else if (currentFrame < section.startFrame) {
        progress.style.width = '0%';
      } else {
        const sectionLength = Math.min(allFrames.length - 1, section.endFrame) - section.startFrame;
        const sectionProgress = (currentFrame - section.startFrame) / sectionLength;
        progress.style.width = (sectionProgress * 100) + '%';
      }
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Timeline preview modal and dragging logic use same timeline variable
    const timeline = document.getElementById('timeline');
    const timelinePreview = document.getElementById('timeline-preview');
    let previewActive = false;

    function updatePreview(e) {
      const rect = timeline.getBoundingClientRect();
      let x = (e.touches && e.touches.length) ? e.touches[0].clientX : e.clientX;
      x = Math.max(rect.left, Math.min(rect.right, x));
      const percent = (x - rect.left) / rect.width;
      const frameIdx = Math.round(percent * (allFrames.length - 1));
      const section = frameStepMap[frameIdx];
      // Position preview
      const previewWidth = 110;
      let left = x - rect.left - previewWidth / 2;
      left = Math.max(0, Math.min(rect.width - previewWidth, left));
      timelinePreview.style.left = left + 'px';
      timelinePreview.style.top = '-90px';

      // Set content
      timelinePreview.innerHTML = `
        <img src="data/${allFrames[frameIdx]}.png" alt="preview" />
        ${section && section.name && section.name.trim() ? `<div class='preview-section'>${section.name}</div>` : ''}
      `;
      timelinePreview.style.display = 'flex';
      timelinePreview.style.opacity = 1;
      previewActive = true;
    }

    timeline.addEventListener('mousemove', updatePreview);
    timeline.addEventListener('touchmove', updatePreview);
    timeline.addEventListener('mouseleave', () => {
      timelinePreview.style.display = 'none';
      previewActive = false;
    });
    timeline.addEventListener('touchend', () => {
      timelinePreview.style.display = 'none';
      previewActive = false;
    });
    document.getElementById('play-pause').onclick = () => {
      if (playing) pause();
      else play();
    };
    document.getElementById('prev-section').onclick = () => gotoSection(-1);
    document.getElementById('next-section').onclick = () => gotoSection(1);

    // Timeline dragging logic
    let isDragging = false;

    function frameFromEvent(e) {
      const rect = timeline.getBoundingClientRect();
      let x = (e.touches && e.touches.length) ? e.touches[0].clientX : e.clientX;
      x = Math.max(rect.left, Math.min(rect.right, x));
      const percent = (x - rect.left) / rect.width;
      return Math.round(percent * (allFrames.length - 1));
    }

    timeline.addEventListener('mousedown', (e) => {
      isDragging = true;
      document.body.style.userSelect = 'none';
      showFrame(frameFromEvent(e));
    });

    window.addEventListener('mousemove', (e) => {
      if (isDragging) {
        showFrame(frameFromEvent(e));
      }
    });

    window.addEventListener('mouseup', (e) => {
      if (isDragging) {
        showFrame(frameFromEvent(e));
        isDragging = false;
        document.body.style.userSelect = '';
      }
    });

    timeline.addEventListener('touchstart', (e) => {
      isDragging = true;
      showFrame(frameFromEvent(e));
    });

    window.addEventListener('touchmove', (e) => {
      if (isDragging) {
        showFrame(frameFromEvent(e));
      }
    });

    window.addEventListener('touchend', (e) => {
      if (isDragging) {
        showFrame(frameFromEvent(e));
        isDragging = false;
      }
    });

    timeline.addEventListener('click', (e) => {
      if (!isDragging) {
        showFrame(frameFromEvent(e));
      }
    });

    document.addEventListener('keydown', (e) => {
      const step = e.shiftKey ? 10 : 1;

      if (e.key === 'ArrowLeft') {
        showFrame(Math.max(0, currentFrame - step));
      } else if (e.key === 'ArrowRight') {
        showFrame(Math.min(allFrames.length - 1, currentFrame + step));
      }

      e.preventDefault();
    });
  });
</script>